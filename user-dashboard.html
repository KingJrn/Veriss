<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Member Dashboard - Veriss Payments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="assets/css/app.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .sidebar {
        width: 260px;
        min-height: 100vh;
        background: white;
        border-right: 1px solid #e5e7eb;
        position: fixed;
        left: 0;
        top: 0;
        padding-top: 80px;
        transition: transform 0.3s ease;
        z-index: 100;
      }

      .sidebar-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1.5rem;
        color: #374151;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border-left: 3px solid transparent;
      }

      .sidebar-item:hover {
        background: #dcfce7;
        color: #15803d;
      }

      .sidebar-item.active {
        background: #dcfce7;
        color: #15803d;
        border-left-color: #16a34a;
        font-weight: 600;
      }

      .main-content {
        margin-left: 260px;
        min-height: 100vh;
        background: #f9fafb;
      }

      .header-bar {
        position: fixed;
        top: 0;
        left: 260px;
        right: 0;
        height: 80px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2rem;
        z-index: 90;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      }

      .content-area {
        margin-top: 80px;
        padding: 2rem;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 2rem;
      }

      .modal-content {
        background: white;
        border-radius: 0.75rem;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
      }

      .modal-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-body {
        padding: 2rem;
      }

      .service-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1.5rem;
        transition: all 0.2s ease;
      }

      .service-card:hover {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        border-color: #86efac;
      }

      .spinner {
        border: 3px solid #e5e7eb;
        border-top: 3px solid #2563eb;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .header-bar {
          left: 0;
        }
      }
    </style>
  </head>

  <body>
    <div id="app">
      <aside class="sidebar" :class="{open:sidebarOpen}">
        <div class="flex flex-col">
          <a @click="setActiveView('dashboard')" :class="['sidebar-item',{active:activeView==='dashboard'}]">
            <i data-lucide="layout-dashboard"></i><span>Dashboard</span>
          </a>
          <a @click="setActiveView('organizations')" :class="['sidebar-item',{active:activeView==='organizations'}]">
            <i data-lucide="building-2"></i><span>My Organizations</span>
          </a>
          <a @click="setActiveView('payment-history')"
            :class="['sidebar-item',{active:activeView==='payment-history'}]">
            <i data-lucide="file-text"></i><span>Payment History</span>
          </a>
        </div>
      </aside>

      <div class="main-content">
        <header class="header-bar" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%)">
          <div class="flex items-center gap-4">
            <button @click="toggleSidebar" class="lg:hidden text-white">
              <i data-lucide="menu"></i>
            </button>
            <h1 class="text-lg font-bold text-white">VERISS PAYMENTS</h1>
          </div>
          <div class="flex items-center gap-4">
            <a href="user-profile.html" class="flex items-center gap-2 cursor-pointer hover:opacity-90">
              <span class="text-white/90 font-semibold">
                {{ currentUser?.name || currentUser?.email || 'Member' }}
              </span>

              <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white font-semibold">
                {{
                (currentUser?.name || currentUser?.email || 'M')
                .charAt(0)
                .toUpperCase()
                }}
              </div>
            </a>

            <button @click="handleLogout"
              class="px-3 py-1.5 text-sm text-white border-2 border-white rounded hover:bg-white hover:text-green-700 transition-all">
              <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>Logout
            </button>
          </div>
        </header>

        <div class="content-area">
          <!-- Loading State -->
          <div v-if="isLoading" class="flex flex-col items-center justify-center py-20">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600">Loading dashboard...</p>
          </div>

          <!-- Dashboard View -->
          <div v-else-if="activeView==='dashboard'" class="dashboard-view">
            <div class="mb-6">
              <h2 class="text-xl font-bold text-gray-900 mb-2">Dashboard Overview</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Subscriptions</h3>
                  <i data-lucide="building-2" class="w-5 h-5 text-blue-600"></i>
                </div>
                <p class="text-3xl font-bold text-blue-600">{{overview.subscriptions||0}}</p>
                <p class="text-xs text-blue-600 mt-1">Active organizations</p>
              </div>

              <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Total Payments</h3>
                  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                </div>
                <p class="text-3xl font-bold text-green-600">{{overview.payments||0}}</p>
                <p class="text-xs text-green-600 mt-1">Completed</p>
              </div>

              <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Total Amount Paid</h3>
                  <i data-lucide="trending-up" class="w-5 h-5 text-green-600"></i>
                </div>
                <p class="text-3xl font-bold text-green-600">₦{{formatCurrency(overview.totalAmountPaid||0)}}</p>
                <p class="text-xs text-green-600 mt-1">All time</p>
              </div>
            </div>

            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
              <h3 class="text-base font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="history" class="w-5 h-5 text-blue-600"></i>Recent Payments
              </h3>
              <div v-if="recentPayments.length===0" class="text-center py-12 text-gray-500">
                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                <p>No recent payments</p>
              </div>
              <div v-else class="space-y-3">
                <div v-for="payment in recentPayments" :key="payment._id"
                  class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 cursor-pointer border border-transparent hover:border-gray-200"
                  @click="viewPaymentDetail(payment._id)">
                  <div>
                    <p class="font-semibold text-gray-900 text-sm">{{payment.service?.id?.name||'N/A'}}</p>
                    <p class="text-xs text-gray-500">{{formatDate(payment.paidAt||payment.initializedAt)}}</p>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-green-600 text-sm">₦{{formatCurrency(payment.serviceCost)}}</p>
                    <span :class="getStatusClass(payment.status)"
                      class="inline-block px-2 py-1 text-xs rounded mt-1">{{payment.status}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Organizations View -->
          <div v-else-if="activeView==='organizations'" class="organizations-view">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold text-gray-900">My Organizations</h2>
              <button @click="openBrowseModal"
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i>Browse Organizations
              </button>
            </div>

            <div v-if="loadingSubscriptions" class="flex justify-center py-12">
              <div class="spinner"></div>
            </div>

            <div v-else-if="subscriptions.length===0" class="text-center py-12 text-gray-500">
              <i data-lucide="building-2" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
              <p class="text-lg font-medium mb-2">No organizations subscribed</p>
              <p class="text-sm mb-4">Browse and subscribe to organizations to access their payment services</p>
              <button @click="openBrowseModal" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Browse Organizations
              </button>
            </div>

            <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div v-for="sub in subscriptions" :key="sub.subscriptionId"
                class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex-1">
                    <h3 class="text-base font-bold text-gray-900 mb-1 cursor-pointer hover:text-blue-600"
                      @click="viewOrganizationDetail(sub.organization._id)">
                      {{sub.organization.name}}
                    </h3>
                    <p class="text-xs text-gray-500">Joined: {{formatDate(sub.joinedAt)}}</p>
                    <span
                      class="inline-block mt-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">{{sub.role}}</span>
                  </div>
                  <button @click="unsubscribeFromOrg(sub.organization._id)"
                    class="text-red-600 hover:text-red-700 text-xs flex items-center gap-1">
                    <i data-lucide="x-circle" class="w-4 h-4"></i>Leave
                  </button>
                </div>

                <div class="mb-4">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-xs font-semibold text-gray-700">Available Services</h4>
                    <button @click="loadOrgServices(sub.organization._id)"
                      class="text-blue-600 hover:text-blue-700 text-xs">
                      <i data-lucide="refresh-cw" class="w-3 h-3 inline"></i>
                    </button>
                  </div>

                  <div v-if="loadingServices[sub.organization._id]" class="flex justify-center py-4">
                    <div class="spinner" style="width: 24px; height: 24px; border-width: 2px"></div>
                  </div>

                  <div v-else-if="!orgServices[sub.organization._id]||orgServices[sub.organization._id].length===0"
                    class="text-center py-6 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                    <i data-lucide="package-x" class="w-10 h-10 mx-auto mb-2 text-gray-400"></i>
                    <p class="text-xs text-gray-500">No active services available</p>
                  </div>

                  <div v-else class="space-y-2">
                    <div v-for="service in orgServices[sub.organization._id]" :key="service._id" class="service-card">
                      <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                          <h5 class="font-semibold text-gray-900 text-sm mb-1">{{service.name}}</h5>
                          <p class="text-xs text-gray-600 mb-2">{{service.description}}</p>
                          <span
                            class="inline-block px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">{{service.type}}</span>
                        </div>
                      </div>
                      <button @click="viewServiceDetail(service._id)"
                        class="w-full mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-xs">
                        View & Pay
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment History View -->
          <div v-else-if="activeView==='payment-history'" class="payment-history-view">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold text-gray-900">Payment History</h2>
            </div>

            <div v-if="loadingPayments" class="flex justify-center py-12">
              <div class="spinner"></div>
            </div>

            <div v-else-if="payments.length===0" class="text-center py-12 text-gray-500">
              <i data-lucide="file-x" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
              <p class="text-lg font-medium mb-2">No payment records found</p>
              <p class="text-sm">Your payment history will appear here</p>
            </div>

            <div v-else class="space-y-3">
              <div v-for="payment in payments" :key="payment._id"
                class="bg-white rounded-lg p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-shadow cursor-pointer"
                @click="viewPaymentDetail(payment._id)">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 text-sm mb-1">{{payment.service?.id?.name||'N/A'}}</h4>
                    <p class="text-xs text-gray-500 mb-2">{{payment.service?.id?.description||''}}</p>
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                      <i data-lucide="calendar" class="w-3 h-3"></i>
                      <span>{{formatDate(payment.paidAt||payment.initializedAt)}}</span>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-gray-900 text-lg">₦{{formatCurrency(payment.serviceCost)}}</p>
                    <span :class="getStatusClass(payment.status)"
                      class="inline-block px-2 py-1 text-xs rounded mt-1">{{payment.status}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Browse Organizations Modal -->
      <div v-if="showBrowseModal" class="modal-overlay" @click.self="closeBrowseModal">
        <div class="modal-content" style="max-width: 800px">
          <div class="modal-header">
            <h3 class="text-lg font-bold">Browse Organizations</h3>
            <button @click="closeBrowseModal" class="text-gray-500 hover:text-gray-900">
              <i data-lucide="x"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <input v-model="searchQuery" @input="searchOrganizations" type="text"
                placeholder="Search organizations..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" />
            </div>

            <div v-if="searchingOrgs" class="flex justify-center py-8">
              <div class="spinner"></div>
            </div>

            <div v-else-if="searchResults.length===0&&searchQuery" class="text-center py-8 text-gray-500">
              <p>No organizations found</p>
            </div>

            <div v-else-if="searchQuery" class="space-y-3 max-h-96 overflow-y-auto">
              <div v-for="org in searchResults" :key="org._id"
                class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors">
                <div class="flex items-start justify-between">
                  <div class="flex-1 cursor-pointer" @click="viewOrganizationDetail(org._id)">
                    <h4 class="font-bold text-gray-900 mb-1 hover:text-blue-600">{{org.name}}</h4>
                    <p class="text-xs text-gray-600 mb-2">{{org.type}}</p>
                    <div class="flex items-center gap-4 text-xs text-gray-500">
                      <span><i data-lucide="users" class="w-3 h-3 inline"></i> {{org.subscribers}} subscribers</span>
                    </div>
                  </div>
                  <button v-if="!org.isSubscribed" @click="subscribeToOrg(org._id)" :disabled="subscribingOrg===org._id"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-xs disabled:opacity-50">
                    <span v-if="subscribingOrg===org._id">Subscribing...</span>
                    <span v-else>Subscribe</span>
                  </button>
                  <span v-else class="px-3 py-2 text-xs rounded bg-green-100 text-green-700">Subscribed</span>
                </div>
              </div>
            </div>

            <div v-else class="text-center py-8 text-gray-500">
              <p class="text-sm">Start typing to search for organizations</p>
            </div>
          </div>
        </div>
      </div>

      <!-- View Organization Modal -->
      <div v-if="showOrgModal&&selectedOrganization" class="modal-overlay" @click.self="closeOrgModal">
        <div class="modal-content" style="max-width: 700px">
          <div class="modal-header">
            <h3 class="text-lg font-bold">Organization Details</h3>
            <button @click="closeOrgModal" class="text-gray-500 hover:text-gray-900">
              <i data-lucide="x"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="space-y-6">
              <div class="p-6 bg-blue-50 rounded-lg">
                <h4 class="font-bold text-gray-900 text-xl mb-3">{{selectedOrganization.name}}</h4>
                <div class="space-y-2 text-sm">
                  <p><strong>Type:</strong> {{selectedOrganization.type}}</p>
                  <p><strong>Email:</strong> {{selectedOrganization.email}}</p>
                  <p v-if="selectedOrganization.city"><strong>City:</strong> {{selectedOrganization.city}}</p>
                  <p><strong>Subscribers:</strong> {{selectedOrganization.subscribers}}</p>
                  <p v-if="selectedOrganization.joinedAt"><strong>Joined:</strong>
                    {{formatDate(selectedOrganization.joinedAt)}}</p>
                  <p v-if="selectedOrganization.role">
                    <strong>Role:</strong>
                    <span class="px-2 py-1 rounded bg-blue-100 text-blue-700">{{selectedOrganization.role}}</span>
                  </p>
                </div>
              </div>
              <div class="flex justify-end gap-3">
                <button @click="closeOrgModal"
                  class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                  Close
                </button>
                <button v-if="!selectedOrganization.isSubscribed" @click="subscribeToOrgFromModal"
                  :disabled="subscribingOrg" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                  <span v-if="subscribingOrg">Subscribing...</span>
                  <span v-else>Subscribe</span>
                </button>
                <button v-else @click="unsubscribeFromOrgModal"
                  class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                  Leave Organization
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View Service Modal -->
      <div v-if="showServiceModal&&selectedService" class="modal-overlay" @click.self="closeServiceModal">
        <div class="modal-content" style="max-width: 700px">
          <div class="modal-header">
            <h3 class="text-lg font-bold">Service Details</h3>
            <button @click="closeServiceModal" class="text-gray-500 hover:text-gray-900">
              <i data-lucide="x"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="space-y-6">
              <div class="p-4 bg-blue-50 rounded-lg">
                <h4 class="font-bold text-gray-900 mb-2">{{selectedService.name}}</h4>
                <p class="text-sm text-gray-600 mb-3">{{selectedService.description}}</p>
                <div class="flex items-center justify-between">
                  <span
                    class="inline-block px-3 py-1 text-sm rounded bg-white text-blue-700 font-semibold">{{selectedService.type}}</span>
                  <p class="text-2xl font-bold text-blue-600">₦{{formatCurrency(selectedService.serviceCost)}}</p>
                </div>
              </div>

              <div v-if="selectedService.customFields&&selectedService.customFields.length>0" class="space-y-4">
                <h4 class="font-bold text-gray-900">Required Information</h4>
                <div v-for="field in selectedService.customFields" :key="field._id" class="space-y-2">
                  <label class="block text-sm font-semibold">
                    {{field.name}}
                    <span v-if="field.required" class="text-red-600">*</span>
                  </label>
                  <input v-if="field.type==='text'" v-model="paymentForm[field.name]" type="text"
                    :placeholder="field.placeholder" :required="field.required"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                  <select v-else-if="field.type==='select-option'" v-model="paymentForm[field.name]"
                    :required="field.required"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="">{{field.placeholder||'Select an option'}}</option>
                    <option v-for="option in field.options" :key="option" :value="option">{{option}}</option>
                  </select>
                </div>
              </div>

              <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button @click="closeServiceModal"
                  class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                  Cancel
                </button>
                <button @click="initializePayment" :disabled="processingPayment"
                  class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 disabled:opacity-50">
                  <i data-lucide="credit-card" class="w-4 h-4"></i>
                  <span v-if="processingPayment">Processing...</span>
                  <span v-else>Pay ₦{{formatCurrency(selectedService.serviceCost)}}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Detail Modal -->
      <div v-if="showPaymentDetailModal&&selectedPayment" class="modal-overlay" @click.self="closePaymentDetailModal">
        <div class="modal-content" style="max-width: 700px">
          <div class="modal-header">
            <h3 class="text-lg font-bold">Payment Details</h3>
            <button @click="closePaymentDetailModal" class="text-gray-500 hover:text-gray-900">
              <i data-lucide="x"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="space-y-6">
              <div class="text-center p-6 rounded-lg"
                :class="selectedPayment.status==='completed'?'bg-green-50':'bg-gray-50'">
                <i :data-lucide="selectedPayment.status==='completed'?'check-circle':'clock'"
                  class="w-16 h-16 mx-auto mb-3"
                  :class="selectedPayment.status==='completed'?'text-green-600':'text-gray-400'"></i>
                <p class="text-lg font-bold mb-2"
                  :class="selectedPayment.status==='completed'?'text-green-700':'text-gray-700'">
                  {{selectedPayment.status==='completed'?'Payment Successful':'Payment Pending'}}
                </p>
              </div>

              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="font-bold text-gray-900 mb-4 text-sm uppercase tracking-wider">Payment Information</h4>
                <div class="space-y-3">
                  <div class="flex justify-between py-2 border-b">
                    <span class="text-sm text-gray-600">Service:</span>
                    <span class="text-sm font-semibold">{{selectedPayment.service?.id?.name}}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b">
                    <span class="text-sm text-gray-600">Amount:</span>
                    <span
                      class="text-lg font-bold text-blue-600">₦{{formatCurrency(selectedPayment.serviceCost)}}</span>
                  </div>
                  <div v-if="selectedPayment.totalAmountPaid" class="flex justify-between py-2 border-b">
                    <span class="text-sm text-gray-600">Total Paid:</span>
                    <span class="text-sm font-semibold">₦{{formatCurrency(selectedPayment.totalAmountPaid)}}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b">
                    <span class="text-sm text-gray-600">Reference:</span>
                    <span class="text-sm font-mono">{{selectedPayment.paymentReference||'N/A'}}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b">
                    <span class="text-sm text-gray-600">Date:</span>
                    <span
                      class="text-sm font-semibold">{{formatDate(selectedPayment.paidAt||selectedPayment.initializedAt)}}</span>
                  </div>
                  <div v-if="selectedPayment.paidToAccountNumber" class="flex justify-between py-2 border-b">
                    <span class="text-sm text-gray-600">Paid To:</span>
                    <div class="text-right">
                      <p class="text-sm font-semibold">{{selectedPayment.paidToAccountNumber}}</p>
                      <p class="text-xs text-gray-500">{{selectedPayment.paidToBankName}}</p>
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="selectedPayment.paidBy" class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-bold text-gray-900 mb-4 text-sm uppercase tracking-wider">Payer Information</h4>
                <div class="space-y-2">
                  <p class="text-sm"><strong>Email:</strong> {{selectedPayment.paidBy.user?.email}}</p>
                  <p class="text-sm" v-if="selectedPayment.paidBy.user?.phoneNumber">
                    <strong>Phone:</strong> {{selectedPayment.paidBy.user?.phoneNumber}}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import Swal from "https://cdn.jsdelivr.net/npm/sweetalert2@11.26.17/+esm";
      import { getCookie, deleteCookie } from "./assets/js/utils/cookies.js";
      import {
        showErrorAlert,
        showSuccessAlert,
      } from "./assets/js/utils/alerts.js";
      import {
        getUserSubscriptionsApi,
        searchOrganizationsApi,
        viewOrganizationApi,
        subscribeToOrganizationApi,
        unsubscribeFromOrganizationApi,
        getOrgServicesApi,
        viewServiceApi,
        initializePaymentApi,
        verifyPaymentApi,
        getUserPaymentsApi,
        getUserRecentPaymentsApi,
        getPaymentByIdApi,
        getOverviewApi,
      } from "./assets/js/services/member/controller.js";
      import { logoutApiMember } from "./assets/js/services/member/auth.js";

      const { createApp } = Vue;

      createApp({
        data() {
          return {
            activeView: "dashboard",
            sidebarOpen: false,
            currentUser: null,
            token: null,
            isLoading: true,
            loadingSubscriptions: false,
            loadingPayments: false,
            loadingServices: {},
            searchingOrgs: false,
            processingPayment: false,
            overview: {},
            subscriptions: [],
            payments: [],
            recentPayments: [],
            orgServices: {},
            searchResults: [],
            selectedService: null,
            selectedPayment: null,
            selectedOrganization: null,
            showBrowseModal: false,
            showServiceModal: false,
            showPaymentDetailModal: false,
            showOrgModal: false,
            searchQuery: "",
            subscribingOrg: null,
            paymentForm: {},
          };
        },
        async mounted() {
          lucide.createIcons();
          const token = getCookie("auth_token");
          if (!token) {
            window.location.href = "login.html";
            return;
          }

          // Check for payment verification in URL
          const urlParams = new URLSearchParams(window.location.search);
          const reference = urlParams.get('reference');
          if (reference) {
            await this.verifyPaymentFromUrl(reference);
          }

          await this.initializeDashboard();
        },
        updated() {
          this.$nextTick(() => {
            lucide.createIcons();
          });
        },
        methods: {
          async initializeDashboard() {
            try {
              this.token = getCookie("auth_token");
              const userData = getCookie("user_data");
              if (!this.token) {
                window.location.href = "login.html";
                return;
              }
              if (userData) {
                try {
                  this.currentUser = JSON.parse(userData);
                } catch (e) {
                  console.error("Error parsing user data:", e);
                }
              }
              await Promise.all([
                this.loadOverview(),
                this.loadSubscriptions(),
                this.loadRecentPayments(),
              ]);
              this.isLoading = false;
            } catch (error) {
              console.error("Initialization error:", error);
              showErrorAlert("Failed to load dashboard");
              this.isLoading = false;
            }
          },
          async loadOverview() {
            try {
              const response = await getOverviewApi(this.token);
              if (response.success) {
                this.overview = response.data;
              }
            } catch (error) {
              console.error("Error loading overview:", error);
            }
          },
          async loadSubscriptions() {
            this.loadingSubscriptions = true;
            try {
              const response = await getUserSubscriptionsApi(this.token);
              if (response.success) {
                this.subscriptions = response.data;
                for (const sub of this.subscriptions) {
                  await this.loadOrgServices(sub.organization._id);
                }
              }
            } catch (error) {
              console.error("Error loading subscriptions:", error);
              showErrorAlert("Failed to load subscriptions");
            } finally {
              this.loadingSubscriptions = false;
            }
          },
          async loadRecentPayments() {
            try {
              const response = await getUserRecentPaymentsApi(this.token);
              if (response.success) {
                this.recentPayments = response.data;
              }
            } catch (error) {
              console.error("Error loading recent payments:", error);
            }
          },
          async loadPayments() {
            this.loadingPayments = true;
            try {
              const response = await getUserPaymentsApi(this.token);
              if (response.success) {
                this.payments = response.data;
              }
            } catch (error) {
              console.error("Error loading payments:", error);
              showErrorAlert("Failed to load payment history");
            } finally {
              this.loadingPayments = false;
            }
          },
          async loadOrgServices(orgId) {
            this.loadingServices[orgId] = true;
            try {
              const response = await getOrgServicesApi(orgId, this.token);
              if (response.success) {
                this.orgServices[orgId] = response.data;
              }
            } catch (error) {
              console.error("Error loading org services:", error);
            } finally {
              this.loadingServices[orgId] = false;
            }
          },
          async searchOrganizations() {
            if (!this.searchQuery || this.searchQuery.length < 2) return;
            this.searchingOrgs = true;
            try {
              const response = await searchOrganizationsApi(
                this.searchQuery,
                this.token
              );
              if (response.success) {
                this.searchResults = response.data;
              }
            } catch (error) {
              console.error("Error searching organizations:", error);
            } finally {
              this.searchingOrgs = false;
            }
          },
          async viewOrganizationDetail(orgId) {
            try {
              Swal.fire({
                title: "Loading...",
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                },
              });
              const response = await viewOrganizationApi(orgId, this.token);
              Swal.close();
              if (response.success) {
                this.selectedOrganization = response.data;
                this.showOrgModal = true;
              }
            } catch (error) {
              Swal.close();
              console.error("Error loading organization:", error);
              showErrorAlert("Failed to load organization details");
            }
          },
          async subscribeToOrg(orgId) {
            this.subscribingOrg = orgId;
            try {
              const response = await subscribeToOrganizationApi(
                orgId,
                this.token
              );
              if (response.success) {
                await showSuccessAlert(
                  response.message || "Successfully subscribed!"
                );
                await this.loadSubscriptions();
                await this.loadOverview();
                this.searchResults = this.searchResults.map((org) =>
                  org._id === orgId ? { ...org, isSubscribed: true } : org
                );
              }
            } catch (error) {
              console.error("Error subscribing:", error);
              showErrorAlert(error.message || "Failed to subscribe");
            } finally {
              this.subscribingOrg = null;
            }
          },
          async subscribeToOrgFromModal() {
            if (!this.selectedOrganization) return;
            this.subscribingOrg = this.selectedOrganization._id;
            try {
              const response = await subscribeToOrganizationApi(
                this.selectedOrganization._id,
                this.token
              );
              if (response.success) {
                await showSuccessAlert(
                  response.message || "Successfully subscribed!"
                );
                this.closeOrgModal();
                await this.loadSubscriptions();
                await this.loadOverview();
              }
            } catch (error) {
              console.error("Error subscribing:", error);
              showErrorAlert(error.message || "Failed to subscribe");
            } finally {
              this.subscribingOrg = null;
            }
          },
          async unsubscribeFromOrg(orgId) {
            if (!confirm("Are you sure you want to leave this organization?"))
              return;
            try {
              await unsubscribeFromOrganizationApi(orgId, this.token);
              await showSuccessAlert("Successfully unsubscribed");
              await this.loadSubscriptions();
              await this.loadOverview();
            } catch (error) {
              console.error("Error unsubscribing:", error);
              showErrorAlert("Failed to unsubscribe");
            }
          },
          async unsubscribeFromOrgModal() {
            if (!this.selectedOrganization) return;
            if (!confirm("Are you sure you want to leave this organization?"))
              return;
            try {
              await unsubscribeFromOrganizationApi(this.selectedOrganization._id, this.token);
              await showSuccessAlert("Successfully unsubscribed");
              this.closeOrgModal();
              await this.loadSubscriptions();
              await this.loadOverview();
            } catch (error) {
              console.error("Error unsubscribing:", error);
              showErrorAlert("Failed to unsubscribe");
            }
          },
          async viewServiceDetail(serviceId) {
            try {
              Swal.fire({
                title: "Loading...",
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                },
              });
              const response = await viewServiceApi(serviceId, this.token);
              Swal.close();
              if (response.success) {
                this.selectedService = response.data;
                this.paymentForm = {};
                this.showServiceModal = true;
              }
            } catch (error) {
              Swal.close();
              console.error("Error loading service:", error);
              showErrorAlert("Failed to load service details");
            }
          },
          async initializePayment() {
            if (this.selectedService.customFields) {
              for (const field of this.selectedService.customFields) {
                if (field.required && !this.paymentForm[field.name]) {
                  showErrorAlert(`Please fill in: ${field.name}`);
                  return;
                }
              }
            }
            this.processingPayment = true;
            try {
              const inputFields = this.selectedService.customFields
                ? this.selectedService.customFields.map((field) => ({
                  name: field.name,
                  type: field.type,
                  value: this.paymentForm[field.name] || field.default,
                }))
                : [];
              const response = await initializePaymentApi(
                { serviceId: this.selectedService._id, inputFields },
                this.token
              );
              if (response.success) {
                this.closeServiceModal();
                // Redirect to payment gateway
                window.open(
                  response.data.authorization_url
                );

              }
            } catch (error) {
              console.error("Error initializing payment:", error);
              showErrorAlert(error.message || "Failed to initialize payment");
            } finally {
              this.processingPayment = false;
            }
          },
          async verifyPaymentFromUrl(reference) {
            try {
              Swal.fire({
                title: "Verifying payment...",
                text: "Please wait while we confirm your payment",
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                },
              });

              const response = await verifyPaymentApi({ reference }, this.token);

              Swal.close();

              if (response.success && response.data.status === 'completed') {
                await Swal.fire({
                  icon: 'success',
                  title: 'Payment Successful!',
                  text: response.message || 'Your payment has been processed successfully',
                  confirmButtonColor: '#16a34a'
                });

                // Refresh dashboard data
                await Promise.all([
                  this.loadOverview(),
                  this.loadRecentPayments(),
                  this.loadPayments()
                ]);

                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
              } else {
                await Swal.fire({
                  icon: 'error',
                  title: 'Payment Failed',
                  text: response.message || 'Payment verification failed. Please contact support.',
                  confirmButtonColor: '#dc2626'
                });
              }
            } catch (error) {
              Swal.close();
              console.error("Error verifying payment:", error);
              await Swal.fire({
                icon: 'error',
                title: 'Verification Error',
                text: error.message || 'Failed to verify payment. Please contact support.',
                confirmButtonColor: '#dc2626'
              });
            }
          },
          async viewPaymentDetail(paymentId) {
            try {
              Swal.fire({
                title: "Loading...",
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                },
              });
              const response = await getPaymentByIdApi(paymentId, this.token);
              Swal.close();
              if (response.success) {
                this.selectedPayment = response.data;
                this.showPaymentDetailModal = true;
              }
            } catch (error) {
              Swal.close();
              console.error("Error loading payment:", error);
              showErrorAlert("Failed to load payment details");
            }
          },
          setActiveView(view) {
            this.activeView = view;
            this.sidebarOpen = false;
            if (view === "payment-history" && this.payments.length === 0) {
              this.loadPayments();
            }
          },
          toggleSidebar() {
            this.sidebarOpen = !this.sidebarOpen;
          },
          openBrowseModal() {
            this.showBrowseModal = true;
            this.searchQuery = "";
            this.searchResults = [];
          },
          closeBrowseModal() {
            this.showBrowseModal = false;
          },
          closeServiceModal() {
            this.showServiceModal = false;
            this.selectedService = null;
            this.paymentForm = {};
          },
          closePaymentDetailModal() {
            this.showPaymentDetailModal = false;
            this.selectedPayment = null;
          },
          closeOrgModal() {
            this.showOrgModal = false;
            this.selectedOrganization = null;
          },
          formatCurrency(amount) {
            return (amount || 0).toLocaleString();
          },
          formatDate(date) {
            if (!date) return "N/A";
            return new Date(date).toLocaleDateString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
            });
          },
          getStatusClass(status) {
            return (
              {
                completed: "bg-green-100 text-green-700",
                pending: "bg-yellow-100 text-yellow-700",
                failed: "bg-red-100 text-red-700",
              }[status] || "bg-gray-100 text-gray-800"
            );
          },
          async handleLogout() {
            if (confirm("Are you sure you want to logout?")) {
              try {
                await logoutApiMember(this.token);
                // On success, clear storage and redirect
                deleteCookie("auth_token");
                deleteCookie("user_data");
                localStorage.removeItem("VerissApp");
                window.location.href = "login.html";
              } catch (error) {
                // Handle API failure: show error message and proceed with local logout
                alert("Logout failed. Please try again or contact support.");
                // Proceed with clearing storage anyway
                deleteCookie("auth_token");
                deleteCookie("user_data");
                localStorage.removeItem("VerissApp");
                window.location.href = "login.html";
              }
            }
          },
        },
      }).mount("#app");
    </script>
  </body>

</html>