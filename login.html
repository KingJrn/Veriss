<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Veriss Payments</title>
    <link rel="stylesheet" href="assets/css/app.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      /* CSS Custom Properties for Veriss Payments Brand Colors */
      :root {
        --primary-50: #f0f9ff;
        --primary-100: #e0f2fe;
        --primary-200: #bae6fd;
        --primary-300: #7dd3fc;
        --primary-400: #38bdf8;
        --primary-500: #0ea5e9;
        --primary-600: #0284c7;
        --primary-700: #0369a1;
        --primary-800: #075985;
        --primary-900: #0c4a6e;

        --neutral-50: #fafafa;
        --neutral-100: #f5f5f5;
        --neutral-200: #e5e5e5;
        --neutral-300: #d4d4d4;
        --neutral-400: #a3a3a3;
        --neutral-500: #737373;
        --neutral-600: #525252;
        --neutral-700: #404040;
        --neutral-800: #262626;
        --neutral-900: #171717;
      }

      /* Modern card styling */
      .modern-card {
        background: white;
        border-radius: 1.5rem;
        padding: 2.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      /* Modern input styling */
      .modern-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--neutral-200);
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: all 0.2s;
        background: white;
      }

      .modern-input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .modern-input::placeholder {
        color: var(--neutral-400);
      }

      /* Button styling */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 600;
        border-radius: 0.75rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        color: white;
        padding: 1rem 1.5rem;
      }

      .btn-primary:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
        transform: translateY(-2px);
      }

      .btn-primary:active:not(:disabled) {
        transform: translateY(0);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: var(--neutral-200);
        color: var(--neutral-700);
        padding: 0.75rem 1.5rem;
      }

      .btn-secondary:hover:not(:disabled) {
        background: var(--neutral-300);
      }

      /* Link styling */
      .modern-link {
        color: var(--primary-600);
        text-decoration: none;
        transition: color 0.2s;
      }

      .modern-link:hover {
        color: var(--primary-700);
        text-decoration: underline;
      }

      /* Modal Overlay */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        padding: 1rem;
        animation: fadeIn 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      /* Modal Content */
      .modal-content {
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 28rem;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }

        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Account Type Radio Cards */
      .account-type-card {
        position: relative;
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 2px solid var(--neutral-300);
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .account-type-card:hover {
        border-color: var(--neutral-400);
      }

      .account-type-card.selected {
        border-color: var(--primary-500);
        background-color: var(--primary-50);
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-neutral-50 to-neutral-100">
    <div id="app" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-md w-full">
        <!-- Back to Home Link -->
        <div class="text-center mb-6">
          <a href="index.html" class="inline-flex items-center gap-2 font-semibold transition-all hover:scale-105"
            style="color: var(--primary-600);">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            Back to Home
          </a>
        </div>

        <div class="modern-card shadow-2xl">
          <!-- Header Section -->
          <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl shadow-lg mb-4"
              style="background: linear-gradient(to bottom right, var(--primary-100), var(--primary-200)); color: var(--primary-600);">
              <i data-lucide="lock" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-extrabold mb-2" style="color: var(--neutral-900);">Welcome Back</h2>
            <p class="font-medium" style="color: var(--neutral-600);">Sign in to continue to your account</p>
          </div>

          <!-- User Type Switch -->
          <div class="flex justify-center mb-7 gap-4">
            <!-- Organization -->
            <button @click="userType = 'organisation'" type="button"
              class="flex items-center gap-2 px-6 py-3 rounded-xl border text-sm font-medium transition-all" :class="userType === 'organisation'
              ? 'border-[#0ea5e9] text-[#0ea5e9] bg-white'
              : 'border-gray-300 text-black hover:border-[#7dd3fc]'">
              <i data-lucide="building-2" class="w-4 h-4"></i>
              <span>Organization</span>
            </button>

            <!-- Member -->
            <button @click="userType = 'member'" type="button"
              class="flex items-center gap-2 px-6 py-3 rounded-xl border text-sm font-medium transition-all" :class="userType === 'member'
              ? 'border-[#0ea5e9] text-[#0ea5e9] bg-white'
              : 'border-gray-300 text-black hover:border-[#7dd3fc]'">
              <i data-lucide="user" class="w-4 h-4"></i>
              <span>Member</span>
            </button>
          </div>

          <!-- Login Form -->
          <form class="space-y-6" @submit.prevent="handleLogin">
            <div class="space-y-5">
              <!-- Email Input -->
              <div>
                <label for="email" class="block text-sm font-bold mb-2" style="color: var(--neutral-700);">
                  Email address
                </label>
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="mail" class="w-5 h-5" style="color: var(--neutral-400);"></i>
                  </div>
                  <input v-model="email" id="email" name="email" type="email" required autocomplete="email"
                    class="modern-input pl-12 text-base" placeholder="you@example.com">
                </div>
              </div>

              <!-- Password Input -->
              <div>
                <label for="password" class="block text-sm font-bold mb-2" style="color: var(--neutral-700);">
                  Password
                </label>
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="key" class="w-5 h-5" style="color: var(--neutral-400);"></i>
                  </div>
                  <input v-model="password" id="password" name="password" :type="showPassword ? 'text' : 'password'"
                    required autocomplete="current-password" class="modern-input pl-12 pr-12 text-base"
                    placeholder="Enter your password">
                  <button type="button" @click="showPassword = !showPassword"
                    class="absolute inset-y-0 right-0 pr-4 flex items-center">
                    <i :data-lucide="showPassword ? 'eye-off' : 'eye'" class="w-5 h-5"
                      style="color: var(--neutral-400);"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Forgot Password Link -->
            <p class="text-center mt-2">
              <a href="#" @click.prevent="showForgotPasswordModal = true" class="modern-link font-semibold">
                Forgot your password?
              </a>
            </p>

            <!-- Submit Button -->
            <div>
              <button type="submit" :disabled="isSubmitting" class="btn btn-primary w-full text-base py-4 shadow-xl">
                <i data-lucide="log-in" class="w-5 h-5"></i>
                <span v-if="!isSubmitting">Sign in</span>
                <span v-else>Signing in...</span>
              </button>
            </div>

            <!-- Sign Up Link -->
            <div class="text-center pt-4" style="border-top: 1px solid var(--neutral-200);">
              <a href="signup.html" class="modern-link font-semibold">Don't have an account? Sign up</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Forgot Password Modal -->
      <div v-if="showForgotPasswordModal" class="modal-overlay" @click.self="closeForgotPasswordModal">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="px-6 py-5 border-b" style="border-color: var(--neutral-200);">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="flex items-center justify-center w-12 h-12 rounded-xl"
                  style="background: var(--primary-100); color: var(--primary-600);">
                  <i data-lucide="key-round" class="w-6 h-6"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold" style="color: var(--neutral-900);">Reset Password</h3>
                  <p class="text-sm" style="color: var(--neutral-600);">Enter your email to receive reset instructions
                  </p>
                </div>
              </div>
              <button type="button" @click="closeForgotPasswordModal"
                class="p-2 rounded-lg transition-colors hover:bg-gray-100">
                <i data-lucide="x" class="w-5 h-5" style="color: var(--neutral-500);"></i>
              </button>
            </div>
          </div>

          <!-- Modal Body -->
          <form @submit.prevent="handleVerifyEmail" class="px-6 py-6 space-y-5">

            <!-- Account Type Selection -->
            <div>
              <label class="block text-sm font-bold mb-3" style="color: var(--neutral-700);">
                Account Type <span style="color: #ef4444;">*</span>
              </label>
              <div class="grid grid-cols-2 gap-3">
                <!-- Member Option -->
                <label class="account-type-card" :class="{ 'selected': forgotPasswordData.accountType === 'member' }">
                  <input v-model="forgotPasswordData.accountType" type="radio" value="member" class="sr-only">
                  <div class="flex items-center gap-3">
                    <i data-lucide="user" class="w-5 h-5"
                      :style="{ color: forgotPasswordData.accountType === 'member' ? 'var(--primary-600)' : 'var(--neutral-400)' }"></i>
                    <span class="font-medium"
                      :style="{ color: forgotPasswordData.accountType === 'member' ? 'var(--primary-700)' : 'var(--neutral-700)' }">
                      Member
                    </span>
                  </div>
                </label>

                <!-- Organization Option -->
                <label class="account-type-card"
                  :class="{ 'selected': forgotPasswordData.accountType === 'organisation' }">
                  <input v-model="forgotPasswordData.accountType" type="radio" value="organisation" class="sr-only">
                  <div class="flex items-center gap-3">
                    <i data-lucide="building-2" class="w-5 h-5"
                      :style="{ color: forgotPasswordData.accountType === 'organisation' ? 'var(--primary-600)' : 'var(--neutral-400)' }"></i>
                    <span class="font-medium"
                      :style="{ color: forgotPasswordData.accountType === 'organisation' ? 'var(--primary-700)' : 'var(--neutral-700)' }">
                      Organisation
                    </span>
                  </div>
                </label>
              </div>
            </div>

            <!-- Email Input -->
            <div>
              <label for="forgot-email" class="block text-sm font-bold mb-2" style="color: var(--neutral-700);">
                Email Address <span style="color: #ef4444;">*</span>
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <i data-lucide="mail" class="w-5 h-5" style="color: var(--neutral-400);"></i>
                </div>
                <input v-model="forgotPasswordData.email" id="forgot-email" type="email" required
                  class="modern-input pl-12 text-base" placeholder="you@example.com">
              </div>
              <p class="mt-2 text-xs" style="color: var(--neutral-500);">
                We'll send password reset instructions to this email address
              </p>
            </div>

            <!-- Modal Footer -->
            <div class="flex gap-3 pt-4">
              <button type="button" @click="closeForgotPasswordModal" class="btn btn-secondary flex-1">
                <i data-lucide="x" class="w-4 h-4"></i>
                Cancel
              </button>
              <button type="submit" :disabled="isForgotPasswordSubmitting" class="btn btn-primary flex-1"
                :class="{ 'opacity-50 cursor-not-allowed': isForgotPasswordSubmitting }">
                <i data-lucide="send" class="w-4 h-4"></i>
                <span>Verify</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script type="module">
      // Import required modules
      import Swal from 'https://cdn.jsdelivr.net/npm/sweetalert2@11.26.17/+esm';

      import { loginApi, sendResetPasswordCodeApi } from './assets/js/services/organisation/auth.js';
      import { loginApiMember, sendResetPasswordCodeApiMember } from './assets/js/services/member/auth.js';
      import { showErrorAlert, showSuccessAlert } from "./assets/js/utils/alerts.js";
      import { setCookie } from "./assets/js/utils/cookies.js";



      const { createApp } = Vue;

      createApp({
        data() {
          return {
            // User type selection (member or organisation)
            userType: 'member',

            // Form fields
            email: '',
            password: '',

            // UI state
            showPassword: false,
            isSubmitting: false,

            // Forgot Password Modal
            showForgotPasswordModal: false,
            isForgotPasswordSubmitting: false,
            forgotPasswordData: {
              email: '',
              accountType: 'member'
            }
          };
        },

        mounted() {
          // Initialize Lucide icons
          lucide.createIcons();
        },

        updated() {
          // Re-initialize Lucide icons after DOM updates
          this.$nextTick(() => {
            lucide.createIcons();
          });
        },

        methods: {
          /**
           * Handles login form submission
           */
          async handleLogin() {
            // Prevent multiple submissions
            if (this.isSubmitting) return;
            this.isSubmitting = true;

            Swal.fire({
              title: "Logging In",
              text: "Please wait while we verify your credentials...",
              allowOutsideClick: false,
              allowEscapeKey: false,
              showConfirmButton: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            try {
              const payload = {
                email: this.email,
                password: this.password,
              };

              // Call login API
              const response =
                this.userType === "member"
                  ? await loginApiMember(payload)
                  : await loginApi(payload);

              // âŒ force API failure into catch
              if (!response?.success) {
                throw new Error(
                  response?.message || "Login failed. Please check your credentials."
                );
              }

              // âœ… success path
              setCookie("auth_token", response.token, 1);

              localStorage.setItem(
                "verissApp",
                JSON.stringify({
                  user_data: response.user,
                  userType: this.userType
                })
              );
              console.log("Login successful:", response);
              showSuccessAlert(response.message || "Login successful!");

              // Redirect based on user type
              if (this.userType === "organisation") {
                window.location.href = "org-dashboard.html";
              } else {
                window.location.href = "user-dashboard.html";
              }

            } catch (error) {
              // âŒ error path
              console.error("Login error:", error);

              setTimeout(() => {
                showErrorAlert(
                  error.response?.data?.message ||
                  error.message ||
                  "An unexpected error occurred. Please try again later."
                );
              }, 1500);

            } finally {
              // ðŸ” always runs
              this.isSubmitting = false;
              Swal.close();
            }
          },

          async handleVerifyEmail() {
            console.log('Forgot Password Data')
            // Prevent multiple submissions
            if (this.isForgotPasswordSubmitting) return;

            this.isForgotPasswordSubmitting = true;

            Swal.fire({
              title: "Verifying Email",
              text: "Please wait while we verify your credentials...",
              allowOutsideClick: false,
              allowEscapeKey: false,
              showConfirmButton: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            try {
              const response =
                this.forgotPasswordData.accountType === "member"
                  ? await sendResetPasswordCodeApiMember(this.forgotPasswordData.email)
                  : await sendResetPasswordCodeApi(this.forgotPasswordData.email);

              // âŒ force API failure into catch
              if (!response?.success) {
                throw new Error(
                  response?.message || "Could not verify email. Please try again."
                );
              }

              // âœ… success path
              window.location.href = `verify-password.html?email=${encodeURIComponent(
                this.forgotPasswordData.email
              )}&type=${this.forgotPasswordData.accountType}`;

              this.closeForgotPasswordModal();

            } catch (error) {
              // âŒ error path (API error, network error, unexpected error)
              console.error("Verify Email error:", error);

              showErrorAlert(
                error.response?.data?.message ||
                error.message ||
                "An unexpected error occurred. Please try again later."
              );

            } finally {
              // ðŸ” always runs
              this.isForgotPasswordSubmitting = false;
              Swal.close();
            }
          },

          /**
           * Closes the forgot password modal
           */
          closeForgotPasswordModal() {
            this.showForgotPasswordModal = false;
            // Reset form data
            this.forgotPasswordData = {
              email: '',
              accountType: 'member'
            };
          },

        },

        watch: {
          /**
           * Watch for user type changes to update icons
           */
          userType() {
            this.$nextTick(() => {
              lucide.createIcons();
            });
          },

          /**
           * Watch for modal visibility to update icons
           */
          showForgotPasswordModal() {
            this.$nextTick(() => {
              lucide.createIcons();
            });
          },

          /**
           * Watch for forgot password account type changes
           */
          'forgotPasswordData.accountType'() {
            this.$nextTick(() => {
              lucide.createIcons();
            });
          }
        }
      }).mount('#app');
    </script>
  </body>

</html>